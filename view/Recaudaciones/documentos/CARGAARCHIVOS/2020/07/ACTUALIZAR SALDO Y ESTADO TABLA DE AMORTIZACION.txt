
	-- Actualizo la tabla ONE.CREDIT de acuerdo a todas las transacciones de pago existentes para este crédito.
	UPDATE ONE.CREDIT
	SET --BALANCE =  B.DUE - ISNULL(B.PAID,0),												-- Actualizo el saldo, lt este saldo es solo de capital y se esta actualizando con todo el monto del credito
	STATE = CASE 
			WHEN (STATE in (4)) AND (B.DUE - ISNULL(B.PAID,0) = 0) THEN 5 
			WHEN (STATE = 5) AND (B.DUE - ISNULL(B.PAID,0) <> 0) THEN 4 
			ELSE STATE END		-- Si el estado del crédito es activo y ha pagado toda la deuda, paso el estado de crédito a cancelado.
	FROM ONE.CREDIT (NOLOCK)A INNER JOIN
	(SELECT SUM(A.VALUE) AS DUE, SUM(B.VALUE) AS PAID, C.CREDIT_ID 
		FROM ONE.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE (NOLOCK) A 
		LEFT OUTER JOIN 
			(SELECT SUM(A.VALUE) AS VALUE, A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID 
				FROM ONE.CREDIT_TRANSACTION_DETAIL (NOLOCK) A 
				INNER JOIN ONE.CREDIT_TRANSACTION (NOLOCK) B ON A.CREDIT_TRANSACTION_ID = B.CREDIT_TRANSACTION_ID 
				WHERE B.CREDIT_ID = @pCreditId AND A.STATUS = 1 AND A.STATE= 1 AND B.STATUS = 1 AND B.STATE = 1
				GROUP BY A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID) B
	ON A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID = B.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID 
	INNER JOIN ONE.AMORTIZATION_TABLE (NOLOCK)C ON A.AMORTIZATION_TABLE_ID = C.AMORTIZATION_TABLE_ID
	WHERE C.CREDIT_ID = @pCreditId AND A.STATUS = 1 AND C.STATUS = 1
	GROUP BY C.CREDIT_ID) B ON A.CREDIT_ID = B.CREDIT_ID
	WHERE A.CREDIT_ID = @pCreditId
	
	
	-- Actualizo la tabla ONE.AMORTIZATION_TABLE de acuerdo a todas las transacciones de pago existentes para este crédito.
	UPDATE ONE.AMORTIZATION_TABLE
	SET TOTAL_BALANCE = B.DUE - ISNULL(B.PAID,0),
	TOTAL_VALUE=B.DUE,
	STATE = CASE 
			WHEN B.DUE = 0 OR (B.DUE - ISNULL(B.PAID,0) <= 0) THEN 2 
			WHEN (B.DUE - ISNULL(B.PAID,0) > 0) AND ISNULL(B.PAID,0) > 0 THEN 1
			ELSE 0 END
	FROM ONE.AMORTIZATION_TABLE (NOLOCK) A INNER JOIN 
	(SELECT SUM(A.VALUE) AS DUE, SUM(B.VALUE) AS PAID, C.AMORTIZATION_TABLE_ID FROM ONE.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE (NOLOCK)A 
	LEFT OUTER JOIN 
	(SELECT SUM(AA.VALUE) AS VALUE, APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID FROM ONE.CREDIT_TRANSACTION_DETAIL (NOLOCK) AA
	INNER JOIN ONE.CREDIT_TRANSACTION (NOLOCK) BB ON AA.CREDIT_TRANSACTION_ID = BB.CREDIT_TRANSACTION_ID
	WHERE AA.STATUS = 1 AND AA.STATE= 1 AND BB.STATUS = 1 AND BB.STATE = 1
	GROUP BY APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID) B
	ON A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID = B.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID 
	INNER JOIN ONE.AMORTIZATION_TABLE (NOLOCK) C
	ON A.AMORTIZATION_TABLE_ID = C.AMORTIZATION_TABLE_ID
	WHERE C.CREDIT_ID = @pCreditId
	AND A.STATUS = 1 AND C.STATUS = 1 
	GROUP BY C.AMORTIZATION_TABLE_ID) B ON A.AMORTIZATION_TABLE_ID = B.AMORTIZATION_TABLE_ID 
	WHERE A.CREDIT_ID = @pCreditId AND A.STATUS = 1 
	--AND B.PAID IS NOT NULL
	
	-- Actualizo el saldo de la tabla APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE conforme a todas las transacciones de pago existentes para este crédito.
	UPDATE ONE.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE		
	SET BALANCE = B.DUE - ISNULL(B.PAID,0), DATE = GETDATE()
	FROM ONE.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE (NOLOCK) A INNER JOIN
	(SELECT A.VALUE AS DUE, B.VALUE AS PAID, A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID
	FROM ONE.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE (NOLOCK) A LEFT OUTER JOIN
	(SELECT SUM(A.VALUE) AS VALUE, A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID 
		FROM ONE.CREDIT_TRANSACTION_DETAIL (NOLOCK) A 
		INNER JOIN ONE.CREDIT_TRANSACTION (NOLOCK)B ON A.CREDIT_TRANSACTION_ID = B.CREDIT_TRANSACTION_ID 
		WHERE B.CREDIT_ID = @pCreditId AND A.STATUS = 1 AND A.STATE= 1 AND B.STATUS= 1 AND B.STATE = 1
	GROUP BY A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID)B ON A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID = B.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID
	INNER JOIN ONE.AMORTIZATION_TABLE (NOLOCK)C ON A.AMORTIZATION_TABLE_ID = C.AMORTIZATION_TABLE_ID WHERE C.CREDIT_ID = @pCreditId AND A.STATUS = 1 AND C.STATUS = 1) B
	ON A.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID = B.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID WHERE A.STATUS = 1	
	
	
	--ACTUALIZO EL SALDO SOLO DE CAPITAL
	UPDATE ONE.CREDIT
	SET BALANCE=AMOUNT-(SELECT SUM(A.VALUE)-SUM(A.BALANCE) AS VALUE FROM ONE.APROVED_AMORTIZATION_TABLE_ADDITIONAL_VALUE (NOLOCK) A 
				INNER JOIN ONE.AMORTIZATION_TABLE (NOLOCK) B ON A.AMORTIZATION_TABLE_ID = B.AMORTIZATION_TABLE_ID 
				INNER JOIN ONE.AMORTIZATION_TABLE_ADDITIONAL_VALUE (NOLOCK) C ON A.AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID = C.AMORTIZATION_TABLE_ADDITIONAL_VALUE_ID
				WHERE CREDIT_ID = @pCreditId AND A.STATUS = 1 AND B.STATUS = 1 AND C.STATUS = 1 AND C.TYPE = 0 )
	WHERE CREDIT_ID=@pCreditId
	
